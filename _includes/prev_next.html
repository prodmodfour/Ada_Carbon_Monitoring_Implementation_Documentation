{%- comment -%}
Prev/Next navigation that works with plain Jekyll Liquid.
Rules now:
• Order by nav_order (fallback: title).
• Ignore pages with nav_exclude: true.
• If a page has children (has_children: true), “Next” goes to its first child.
• If on a child:
   - Prev → previous sibling (or parent if first)
   - Next → next sibling (or next top-level if last)
• Otherwise linear top-level prev/next.
{%- endcomment -%}

{%- assign all = site.pages | where_exp: "p", "p.nav_exclude != true" -%}
{%- assign ordered = all | sort: "nav_order" -%}
{%- assign ordered = ordered | sort: "title" -%} {# stable-ish tiebreak #}

{%- assign here = page -%}

{%- comment %} build children map by comparing parent title {% endcomment -%}
{%- assign top_level = "" | split: "" -%}
{%- for p in ordered -%}
  {%- unless p.parent -%}
    {%- assign top_level = top_level | push: p -%}
  {%- endunless -%}
{%- endfor -%}

{%- comment %} helpers to get children for a given parent title {% endcomment -%}
{%- assign children_of_here = "" | split: "" -%}
{%- if here.title and here.has_children -%}
  {%- for p in ordered -%}
    {%- if p.parent == here.title -%}
      {%- assign children_of_here = children_of_here | push: p -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- assign siblings = "" | split: "" -%}
{%- if here.parent -%}
  {%- for p in ordered -%}
    {%- if p.parent == here.parent -%}
      {%- assign siblings = siblings | push: p -%}
    {%- endif -%}
  {%- endfor -%}
{%- else -%}
  {%- assign siblings = top_level -%}
{%- endif -%}

{%- comment %} find prev/next among siblings {% endcomment -%}
{%- assign prev = nil -%}
{%- assign next = nil -%}
{%- assign found = false -%}
{%- assign last_seen = nil -%}
{%- for p in siblings -%}
  {%- if found and next == nil -%}{%- assign next = p -%}{%- break -%}{%- endif -%}
  {%- if p.url == here.url -%}
    {%- assign prev = last_seen -%}
    {%- assign found = true -%}
  {%- endif -%}
  {%- assign last_seen = p -%}
{%- endfor -%}

{%- if here.parent -%}
  {# Child page rules #}
  {%- if prev == nil -%}
    {%- comment %} first child → prev is parent {% endcomment -%}
    {%- assign parent_page = nil -%}
    {%- for p in ordered -%}{%- if p.title == here.parent -%}{%- assign parent_page = p -%}{%- break -%}{%- endif -%}{%- endfor -%}
    {%- assign prev = parent_page -%}
  {%- endif -%}

  {%- if next == nil -%}
    {%- comment %} last child → next is next top-level after the parent {% endcomment -%}
    {%- assign parent_page = nil -%}
    {%- for p in ordered -%}{%- if p.title == here.parent -%}{%- assign parent_page = p -%}{%- break -%}{%- endif -%}{%- endfor -%}
    {%- assign seen_parent = false -%}
    {%- for tp in top_level -%}
      {%- if seen_parent -%}{%- assign next = tp -%}{%- break -%}{%- endif -%}
      {%- if tp.url == parent_page.url -%}{%- assign seen_parent = true -%}{%- endif -%}
    {%- endfor -%}
  {%- endif -%}

{%- else -%}
  {# Top-level page rules #}
  {%- if next == nil -%}
    {%- comment %} last top-level → next remains nil {% endcomment -%}
  {%- endif -%}

  {%- if next == nil and here.has_children -%}
    {%- comment %} fallback: if no next sibling but has children, send to first child {% endcomment -%}
    {%- assign first_child = nil -%}
    {%- for c in ordered -%}
      {%- if c.parent == here.title -%}{%- assign first_child = c -%}{%- break -%}{%- endif -%}
    {%- endfor -%}
    {%- if first_child -%}{%- assign next = first_child -%}{%- endif -%}
  {%- else -%}
    {%- if here.has_children and next -%}
      {%- comment %} prefer first child over next top-level {% endcomment -%}
      {%- assign first_child = nil -%}
      {%- for c in ordered -%}
        {%- if c.parent == here.title -%}{%- assign first_child = c -%}{%- break -%}{%- endif -%}
      {%- endfor -%}
      {%- if first_child -%}{%- assign next = first_child -%}{%- endif -%}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}

<nav class="prev-next" style="display:flex;justify-content:space-between;gap:1rem;margin-top:2rem;">
  <div>
    {%- if prev -%}
      <a class="btn btn-outline" href="{{ prev.url | relative_url }}">&larr; {{ prev.title }}</a>
    {%- endif -%}
  </div>
  <div>
    {%- if next -%}
      <a class="btn btn-primary" href="{{ next.url | relative_url }}">{{ next.title }} &rarr;</a>
    {%- endif -%}
  </div>
</nav>
